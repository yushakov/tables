{% extends 'base.html' %}
{% block title %}View Invoice{% endblock %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'list/style.css' %}">
{% if not user_is_owner and 'is_staff' not in perms %}

Sorryan, user <b>{{ username }}</b> is  not authorised to view the invoice with id <b>{{ invoice.id }}</b>.
Please, report to administrators, if you think this is an issue.

{% else %}

<h2>Invoice</h2>
{% if 'is_staff' in perms %}
    &larr; <a href="{% url 'list:index' %}">to the project list</a>
    &nbsp;&nbsp;<a href="{% url 'admin:list_invoice_changelist' %}">see all invoices</a>
{% endif %}
{% if 'list.change_invoice' in perms %}
    &nbsp;&nbsp;<a href="{% url 'list:modify_invoice' invoice.id %}">modify this one</a>
{% endif %}
{% if 'is_staff' in perms %}
    <script>
        function modifyLinkAndRedirect() {
            var userId = document.getElementById('staff-select').value;
            var printAsLink = document.getElementById('print-as-link');
            var originalHref = printAsLink.getAttribute('href');
            var newHref = originalHref + "?user_id=" + userId;
            window.open(newHref, '_blank');
        }
    </script>
    &nbsp;&nbsp;<a href="{% url 'list:print_invoice' invoice.id %}" id="print-as-link"
                   onclick="event.preventDefault(); modifyLinkAndRedirect();">print as:</a>
    <select id='staff-select'>
    {% for u in staff_users %}
        {% if u.username == username %}
            <option value="{{ u.id }}" selected>{{u.first_name}} {{u.last_name}} ({{u.username}})</option>
        {% else %}
            <option value="{{ u.id }}">{{u.first_name}} {{u.last_name}} ({{u.username}})</option>
        {% endif %}
    {% endfor %}
    </select>
{% endif %}
<br />
<br />
<p>
    
<label for='id_project'><b>Project:</b></label>
    {% if 'is_staff' in perms %}
        <a href="{% url 'list:detail' invoice.construct.id %}" id='id_project'>
    {% else %}
        <a href="{% url 'list:submit_invoice' %}?construct={{ invoice.construct.id }}&worker">
    {% endif %}
        {{ invoice.construct.title_text }}
    </a>
</p>
<p>
    <label for='id_number'><b>Number:</b></label>
    <span id='id_number'>{{ invoice.number }}</span>
</p>
<p>
    <label for='id_seller'><b>Seller:</b></label>
    <span id='id_seller'>{{ invoice.seller }}</span>
</p>
<p>
    <label for='id_amount'><b>Amount:</b></label>
    <span id='id_amount' style='font-size: larger'>£ {{ invoice.amount }}</span>
    {% if mismatch %}
        <script>
            const amount_field = document.getElementById('id_amount');
            amount_field.style.color = 'red';
        </script>
    {% endif %}
</p>
<p>
    <label for='id_inout'><b>In/Out:</b></label>
    <span id='id_inout'>{{ invoice.invoice_type }}</span>
</p>
<p>
    <label for='id_issue'><b>Issue Date:</b></label>
    <span id='id_issue'>{{ invoice.issue_date }}</span>
</p>
<p>
    <label for='id_due'><b>Due Date:</b></label>
    <span id='id_due'>{{ invoice.due_date }}</span>
</p>
<p>
    <label for='id_status'><b>Status:</b></label>
    <span id='id_status'>{{ invoice.status }}</span>
</p>
<p>
    {% if invoice.status == 'Paid' %}
        <label for='id_paid_by'><b>Paid By:</b></label>
        <span id='id_paid_by'>
            {% for tra in transactions %}
                <a href="{% url 'list:view_transaction' tra.id %}">{{ tra.number }}</a>:
                    £ {{ tra.amount }}. From: {{ tra.from }}.<br />
            {% endfor %}
        </span>
        {% if mismatch %}
            <label for='id_total_paid'><b>total paid:</b>
            <span style='color: red; font-weight: bold'>
                £ {{ total_paid }}</span>.
            <span id='id_link_to_pay_more'>
                <a href="{% url 'list:submit_transaction' %}?construct={{invoice.construct.id}}&to={{ invoice.seller }}&amount={{ pay_more }}&invoice={{invoice.id}}&type={{invoice.invoice_type}}">
                    pay more
                </a>
            </span>
        {% endif %}
    {% else %}
        {% if 'is_staff' in perms %}
            <label for='id_link_to_pay'><b>Link to pay:</b></label>
            <span id='id_link_to_pay'>
                <a href="{% url 'list:submit_transaction' %}?construct={{invoice.construct.id}}&to={{ invoice.seller }}&amount={{invoice.amount}}&invoice={{invoice.id}}&type={{invoice.invoice_type}}">pay</a>
            </span>
        {% endif %}
    {% endif %}
</p>
<p>
    <label for='id_details'><b>Details:</b></label>
    <div id='id_details' style='max-width: 400px'>{{ invoice.details_txt|linebreaks }}</div>
</p>
{% if invoice.photo %}
    <br />
    <a href="{{ invoice.photo.url }}">
        {% if invoice.photo.width > 500 %}
            <img src="{{ invoice.photo.url }}" width="500">
        {% else %}
            <img src="{{ invoice.photo.url }}">
        {% endif %}
    </a>
{% endif %}

{% endif %}
{% endblock %}
